SELECT TILL_RECEIPT_NUMBER, customersT.CUSTOMER_ID, CU_AGE_RANGE, CU_GENDER, CUSHOM, FSPTS, FSRDM, NUM_ITEMS_IN_BASKET, Grocery, Deli, Tobacco, Produce, Bakery, Lottery
FROM (SELECT TILL_RECEIPT_NUMBER, CUSTOMER_ID, SUM(QUANTITY_SOLD) AS NUM_ITEMS_IN_BASKET,
IIF(SUM(IIF(SUB_DEPARTMENT in (7,3,6,4,5,1), sales_value, NULL))>0, 1,NULL) AS Grocery,
IIF(SUM(IIF(SUB_DEPARTMENT in (83,84,90,85,93,86,88,89,94,95,96,87,97,98,91,92), sales_value, NULL))>0, 1,NULL) AS Deli,
IIF(SUM(IIF(SUB_DEPARTMENT in (78,79), sales_value, NULL))>0, 1,NULL) AS Tobacco,
IIF(SUM(IIF(SUB_DEPARTMENT in (33,34,32,30,35), sales_value, NULL))>0, 1,NULL) AS Produce,
IIF(SUM(IIF(SUB_DEPARTMENT in (40,44,42,46,43,41), sales_value, NULL))>0, 1,NULL) AS Bakery,
IIF(SUM(IIF(SUB_DEPARTMENT in (26,20,23,27,28,24,29,21,22,25), sales_value, NULL))>0, 1,NULL) AS Meat,
IIF(SUM(IIF(SUB_DEPARTMENT in (160,161,201), sales_value, NULL))>0, 1,NULL) AS Lottery
FROM transactionsT
WHERE QUANTITY_SOLD >= 0
GROUP BY TILL_RECEIPT_NUMBER, CUSTOMER_ID)  AS baskets INNER JOIN customersT ON baskets.CUSTOMER_ID = customersT.CUSTOMER_ID;

